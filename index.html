<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MAPEO DE REDES Y COLECTIVOS DE EXTREMADURA</title>

  <!-- Mapbox GL -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.css" rel="stylesheet" />

  <!-- CSS base opcional -->
  <link rel="stylesheet" href="style.css" />

  <style>
    :root{
      --verde:#2ecc71;
      --gris:#6b7280;
      --sombra:0 2px 8px rgba(0,0,0,.12);
      --alto-header: 84px;
    }

    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }

    /* Encabezado fijo */
    .topbar{
      position: fixed;
      top:0; left:0; right:0;
      z-index:1000;
      background:#fff;
      box-shadow: 0 3px 8px rgba(0,0,0,.12); /* sombra sutil */
    }
    .topbar-inner{
      max-width: 1200px;
      margin: 0 auto;
      padding: 10px 16px;
      display:flex; align-items:center; gap:14px;
    }
    .topbar img.logo{ height:56px; width:auto; object-fit:contain; }
    .titles{ display:flex; flex-direction:column; gap:2px; }
    .titles .title{
      color: var(--verde);
      font-weight: 800;
      letter-spacing: .5px;
      text-transform: uppercase;
      font-size: clamp(16px, 2.2vw, 22px);
    }
    .titles .subtitle{ color: var(--gris); font-size: 14px; }

    /* Mapa ocupa toda la pantalla menos el header */
    #map{
      position: fixed;
      top: var(--alto-header);
      left:0; right:0; bottom:0;
      width:100%; height: calc(100vh - var(--alto-header));
    }

    /* Filtros y leyenda */
    .filters{
      position: absolute;
      top: calc(var(--alto-header) + 10px);
      left: 10px;
      background: rgba(255,255,255,.95);
      padding: 10px 12px;
      border-radius: 12px;
      box-shadow: var(--sombra);
      z-index: 1001;
      font-size: 14px;
    }
    .legend{
      position: absolute;
      left: 10px; bottom: 10px;
      background: rgba(255,255,255,.95);
      padding: 10px 12px;
      border-radius: 12px;
      box-shadow: var(--sombra);
      z-index: 1001;
      font-size: 13px;
    }
    .legend .row{ display:flex; align-items:center; gap:8px; margin:4px 0; }
    .legend .dot{ width:12px; height:12px; border-radius:50%; border:1px solid #fff; display:inline-block; }
    .dot.social{ background:#3498db; }
    .dot.ambiental{ background:#2ecc71; }
    .dot.economica{ background:#f1c40f; }
    .dot.otra{ background:#9b59b6; }

    /* Buscador */
    .searchbox{
      position: absolute;
      top: calc(var(--alto-header) + 10px);
      right: 10px;
      width: min(380px, 80vw);
      z-index: 1002;
    }
    .searchbox input{
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 12px;
      box-shadow: var(--sombra);
      font-size: 14px;
    }
    .suggestions{
      list-style: none;
      margin: 6px 0 0 0;
      padding: 0;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      box-shadow: var(--sombra);
      max-height: 260px;
      overflow-y: auto;
      display:none;
    }
    .suggestions li{
      padding: 8px 10px;
      cursor: pointer;
      border-bottom: 1px solid #f3f4f6;
      display:flex; justify-content:space-between; gap:8px;
    }
    .suggestions li:last-child{ border-bottom:none; }
    .suggestions li:hover{ background:#f9fafb; }
    .s-localidad{ color:#6b7280; font-size:12px; white-space:nowrap; }

    @media (max-width: 640px){
      .topbar img.logo{ height:46px; }
      :root{ --alto-header: 76px; }
    }
  </style>
</head>
<body>
  <!-- Encabezado -->
  <div class="topbar">
    <div class="topbar-inner">
      <img src="LOGO_CONGDEX.png" alt="CONGDEX" class="logo" />
      <div class="titles">
        <div class="title">MAPEO DE REDES Y COLECTIVOS DE EXTREMADURA</div>
        <div class="subtitle">Con el apoyo de la Diputación Provincial de Cáceres</div>
      </div>
    </div>
  </div>

  <!-- Mapa -->
  <div id="map"></div>

  <!-- Filtros -->
  <div class="filters">
    <label><input type="checkbox" id="chkSocial" checked> Social</label><br>
    <label><input type="checkbox" id="chkAmbiental" checked> Ambiental</label><br>
    <label><input type="checkbox" id="chkEconomica" checked> Económica</label><br>
    <label><input type="checkbox" id="chkOtra" checked> Otra</label>
  </div>

  <!-- Leyenda -->
  <div class="legend">
    <div class="row"><span class="dot social"></span>Social (<span id="countSocial">0</span>)</div>
    <div class="row"><span class="dot ambiental"></span>Ambiental (<span id="countAmbiental">0</span>)</div>
    <div class="row"><span class="dot economica"></span>Económica (<span id="countEconomica">0</span>)</div>
    <div class="row"><span class="dot otra"></span>Otra (<span id="countOtra">0</span>)</div>
  </div>

  <!-- Buscador -->
  <div class="searchbox">
    <input id="searchInput" type="text" placeholder="Buscar entidad por nombre..." autocomplete="off" />
    <ul id="suggestions" class="suggestions"></ul>
  </div>

  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoibW1pbGFjIiwiYSI6ImNpeWhkNXZsMDA1ZDgzMm4wdWRzdzRleWcifQ.crLVL3iFWYSbE5zrlkIA7w';

    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/light-v11',
      center: [-6.372, 39.475], // Cáceres
      zoom: 8.5
    });
    map.addControl(new mapboxgl.NavigationControl());

    const icons = {
      'Social': 'icon_social.png',
      'Ambiental': 'icon_ambiental.png',
      'Económica': 'icon_economica.png',
      'Otra': 'icon_otra.png'
    };
    const counts = { 'Social': 0, 'Ambiental': 0, 'Económica': 0, 'Otra': 0 };
    let activePopup = null;
    let allEntities = [];

    map.on('load', () => {
      fetch('entidades.geojson')
        .then(r => r.json())
        .then(data => {
          // Preparar contadores y buscador
          data.features.forEach(f => {
            const cat = f.properties.categoria;
            if (counts[cat] !== undefined) counts[cat]++;
            allEntities.push({
              name: f.properties.nombre_entidad || '(Sin nombre)',
              localidad: f.properties.localidad || '',
              coord: f.geometry && f.geometry.coordinates ? f.geometry.coordinates.slice() : null,
              properties: f.properties
            });
          });
          document.getElementById('countSocial').textContent = counts['Social'];
          document.getElementById('countAmbiental').textContent = counts['Ambiental'];
          document.getElementById('countEconomica').textContent = counts['Económica'];
          document.getElementById('countOtra').textContent = counts['Otra'];

          // Crear una capa por categoría con íconos y efecto hover (feature-state)
          Object.keys(icons).forEach(cat => {
            const fc = {
              type: 'FeatureCollection',
              features: data.features.filter(f => f.properties.categoria === cat)
            };

            // Cargar imagen y añadir capa
            map.loadImage(icons[cat], (error, image) => {
              if (error) { console.error('No se pudo cargar el icono', icons[cat]); return; }
              const iconName = cat + '-icon';
              if (!map.hasImage(iconName)) map.addImage(iconName, image, { sdf: false });

              map.addSource('src-' + cat, { type: 'geojson', data: fc, generateId: true });

              map.addLayer({
                id: 'layer-' + cat,
                type: 'symbol',
                source: 'src-' + cat,
                layout: {
                  'icon-image': iconName,
                  'icon-allow-overlap': true,
                  'icon-size': [
                    'case',
                    ['boolean', ['feature-state', 'hover'], false],
                    0.9,   // hover → más grande (≈36px)
                    0.8    // normal (≈32px)
                  ]
                }
              });

              // Hover: agrandar sólo el feature bajo el ratón
              let hoveredId = null;
              map.on('mouseenter', 'layer-' + cat, (e) => {
                map.getCanvas().style.cursor = 'pointer';
                if (e.features.length > 0) {
                  if (hoveredId !== null) {
                    map.setFeatureState({ source: 'src-' + cat, id: hoveredId }, { hover: false });
                  }
                  hoveredId = e.features[0].id;
                  map.setFeatureState({ source: 'src-' + cat, id: hoveredId }, { hover: true });
                }
              });
              map.on('mouseleave', 'layer-' + cat, () => {
                map.getCanvas().style.cursor = '';
                if (hoveredId !== null) {
                  map.setFeatureState({ source: 'src-' + cat, id: hoveredId }, { hover: false });
                }
                hoveredId = null;
              });

              // Click: flyTo + popup (cerrando el anterior)
              map.on('click', 'layer-' + cat, (e) => {
                const coordinates = e.features[0].geometry.coordinates.slice();
                const p = e.features[0].properties;

                if (activePopup) activePopup.remove();
                map.flyTo({ center: coordinates, zoom: 12, speed: 0.8 });

                const html = `
                  <strong>${p.nombre_entidad || ''}</strong><br>
                  <a href="${p.pagina_contacto || '#'}" target="_blank" rel="noopener">Web</a><br>
                  <b>Temática:</b> ${p.tematica || ''}<br>
                  <b>Ámbito:</b> ${p.ambito_geografico || ''}<br>
                  <b>Localidad:</b> ${p.localidad || ''}<br>
                  <b>Teléfono:</b> ${p.telefono || ''}<br>
                  <b>Correo:</b> ${p.correo || ''}
                `;

                activePopup = new mapboxgl.Popup({ closeOnClick: false })
                  .setLngLat(coordinates)
                  .setHTML(html)
                  .addTo(map);
              });
            });
          });

          // Filtros de visibilidad
          document.getElementById('chkSocial').addEventListener('change', (e) => {
            map.setLayoutProperty('layer-Social', 'visibility', e.target.checked ? 'visible' : 'none');
          });
          document.getElementById('chkAmbiental').addEventListener('change', (e) => {
            map.setLayoutProperty('layer-Ambiental', 'visibility', e.target.checked ? 'visible' : 'none');
          });
          document.getElementById('chkEconomica').addEventListener('change', (e) => {
            map.setLayoutProperty('layer-Económica', 'visibility', e.target.checked ? 'visible' : 'none');
          });
          document.getElementById('chkOtra').addEventListener('change', (e) => {
            map.setLayoutProperty('layer-Otra', 'visibility', e.target.checked ? 'visible' : 'none');
          });

          // Buscador predictivo
          const input = document.getElementById('searchInput');
          const list = document.getElementById('suggestions');

          function renderSuggestions(items){
            if (!items.length){ list.style.display='none'; list.innerHTML=''; return; }
            list.innerHTML = items.map(it => (
              `<li data-coord="${it.coord ? it.coord.join(',') : ''}">
                 <span>${it.name}</span>
                 <span class="s-localidad">${it.localidad || ''}</span>
               </li>`
            )).join('');
            list.style.display='block';
          }

          input.addEventListener('input', () => {
            const q = input.value.trim().toLowerCase();
            if (!q){ renderSuggestions([]); return; }
            const results = allEntities
              .filter(e => e.name && e.name.toLowerCase().includes(q))
              .slice(0, 8);
            renderSuggestions(results);
          });

          list.addEventListener('click', (ev) => {
            const li = ev.target.closest('li');
            if (!li) return;
            const coordStr = li.getAttribute('data-coord');
            if (!coordStr) return;
            const [lng, lat] = coordStr.split(',').map(Number);
            const entity = allEntities.find(e => e.coord && e.coord[0] === lng && e.coord[1] === lat);
            renderSuggestions([]);
            if (entity){
              if (activePopup) activePopup.remove();
              map.flyTo({ center: entity.coord, zoom: 12, speed: 0.9 });
              const p = entity.properties || {};
              const html = `
                <strong>${p.nombre_entidad || ''}</strong><br>
                <a href="${p.pagina_contacto || '#'}" target="_blank" rel="noopener">Web</a><br>
                <b>Temática:</b> ${p.tematica || ''}<br>
                <b>Ámbito:</b> ${p.ambito_geografico || ''}<br>
                <b>Localidad:</b> ${p.localidad || ''}<br>
                <b>Teléfono:</b> ${p.telefono || ''}<br>
                <b>Correo:</b> ${p.correo || ''}
              `;
              activePopup = new mapboxgl.Popup({ closeOnClick: false })
                .setLngLat(entity.coord)
                .setHTML(html)
                .addTo(map);
            }
          });

          // Cerrar sugerencias al hacer clic fuera
          document.addEventListener('click', (e) => {
            if (!document.querySelector('.searchbox').contains(e.target)) {
              list.style.display='none';
            }
          });
        });
    });
  </script>
</body>
</html>
