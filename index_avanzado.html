<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Mapa Interactivo de Entidades</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Mapbox -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.js"></script>
  <link rel="stylesheet" href="style.css" />
  <style>
    #map { width: 100%; height: 100vh; }
    .filters {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255,255,255,0.9);
      padding: 10px 15px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      font-family: system-ui, sans-serif;
      font-size: 14px;
    }
    .legend {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(255,255,255,0.9);
      padding: 10px 15px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      font-family: system-ui, sans-serif;
      font-size: 13px;
      line-height: 1.4;
    }
    .legend .row { display: flex; align-items: center; margin: 4px 0; }
    .legend .dot { width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; border: 1px solid #fff; }
    .ambiental { background: #2ecc71; }
    .social { background: #3498db; }
    .economica { background: #f1c40f; }
    h3 { margin: 0; color: #333; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="filters">
    <label><input type="checkbox" id="chkAmbiental" checked> Ambiental</label><br>
    <label><input type="checkbox" id="chkSocial" checked> Social</label><br>
    <label><input type="checkbox" id="chkEconomica" checked> Económica</label>
  </div>

  <div class="legend" id="legend">
    <strong>Categorías</strong><br>
    <div class="row"><span class="dot ambiental"></span>Ambiental (<span id="countAmbiental">0</span>)</div>
    <div class="row"><span class="dot social"></span>Social (<span id="countSocial">0</span>)</div>
    <div class="row"><span class="dot economica"></span>Económica (<span id="countEconomica">0</span>)</div>
  </div>

  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoibW1pbGFjIiwiYSI6ImNpeWhkNXZsMDA1ZDgzMm4wdWRzdzRleWcifQ.crLVL3iFWYSbE5zrlkIA7w';

    const map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/streets-v12',
  center: [-6.338, 39.472],
  zoom: 7
});

   
    map.addControl(new mapboxgl.NavigationControl());

    map.on('load', () => {
      fetch('entidades.geojson')
        .then(res => res.json())
        .then(data => {
          const categorias = ['Ambiental', 'Social', 'Económica'];
          const iconos = {
            'Ambiental': 'park-15',
            'Social': 'town-hall-15',
            'Económica': 'bank-15'
          };
          const colores = {
            'Ambiental': '#2ecc71',
            'Social': '#3498db',
            'Económica': '#f1c40f'
          };

          // Contadores
          const counts = { 'Ambiental': 0, 'Social': 0, 'Económica': 0 };

          // Contar por categoría
          data.features.forEach(f => {
            const cat = f.properties.categoria;
            if (counts[cat] !== undefined) counts[cat]++;
          });
          document.getElementById('countAmbiental').textContent = counts['Ambiental'];
          document.getElementById('countSocial').textContent = counts['Social'];
          document.getElementById('countEconomica').textContent = counts['Económica'];

          // Crear capas por categoría
          categorias.forEach(cat => {
            map.addSource(cat, {
              type: 'geojson',
              data: {
                type: 'FeatureCollection',
                features: data.features.filter(f => f.properties.categoria === cat)
              }
            });

            map.addLayer({
              id: `layer-${cat}`,
              type: 'symbol',
              source: cat,
              layout: {
                'icon-image': iconos[cat],
                'icon-size': 1.2,
                'icon-allow-overlap': true
              },
              paint: {
                'icon-color': colores[cat]
              }
            });
          });

          // Popups
          categorias.forEach(cat => {
            map.on('click', `layer-${cat}`, (e) => {
              const p = e.features[0].properties;
              const html = `
                <h3>${p.nombre_entidad}</h3>
                <p><b>Temática:</b> ${p.tematica}</p>
                <p><b>Ámbito:</b> ${p.ambito_geografico}</p>
                <p><b>Localidad:</b> ${p.localidad}</p>
                <p><b>Teléfono:</b> ${p.telefono}</p>
                <p><b>Correo:</b> <a href="mailto:${p.correo}">${p.correo}</a></p>
                <p><a href="${p.pagina_contacto}" target="_blank" rel="noopener">Página de contacto</a></p>`;
              new mapboxgl.Popup().setLngLat(e.lngLat).setHTML(html).addTo(map);
            });
          });

          // Filtros
          document.getElementById('chkAmbiental').addEventListener('change', (e) => {
            map.setLayoutProperty('layer-Ambiental', 'visibility', e.target.checked ? 'visible' : 'none');
          });
          document.getElementById('chkSocial').addEventListener('change', (e) => {
            map.setLayoutProperty('layer-Social', 'visibility', e.target.checked ? 'visible' : 'none');
          });
          document.getElementById('chkEconomica').addEventListener('change', (e) => {
            map.setLayoutProperty('layer-Económica', 'visibility', e.target.checked ? 'visible' : 'none');
          });
        });
    });
  </script>
</body>
</html>
